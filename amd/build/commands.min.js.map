{"version":3,"file":"commands.min.js","sources":["../src/commands.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Common values helper for the Moodle tiny_corrections plugin.\n *\n * @module      tiny_corrections\n * @copyright   2024 Universit√© de Lausanne\n * @author      Nicolas Alexandropoulos <nicolas.alexandropoulos@unil.ch>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {get_string as getString} from 'core/str';\nimport {component} from './common';\nimport {getCorrTypes} from \"./options\";\n\n\nexport const getSetup = async () => {\n    const [\n        addCorrectionButtonTitle,\n        removeCorrectionButtonTitle,\n    ] = await Promise.all([\n        getString('button_addcorrection', component),\n        getString('button_removecorrection', component),\n    ]);\n\n    let addIcon = await fetch(window.M.cfg.wwwroot + \"/lib/editor/tiny/plugins/corrections/pix/add.svg\")\n        .then((response) => response.text());\n    let removeIcon = await fetch(window.M.cfg.wwwroot + \"/lib/editor/tiny/plugins/corrections/pix/remove.svg\")\n        .then((response) => response.text());\n\n    return (editor) => {\n        editor.ui.registry.addIcon('commentAdd', addIcon);\n        editor.ui.registry.addIcon('commentRemove', removeIcon);\n\n        editor.contentCSS.push(window.M.cfg.wwwroot + '/lib/editor/tiny/plugins/corrections/styles.css');\n\n        editor.ui.registry.addButton('add_correction', {\n            icon: 'commentAdd',\n            tooltip: addCorrectionButtonTitle,\n            onAction: () => openCorrectionModal(editor)\n        });\n\n        editor.ui.registry.addButton('remove_correction', {\n            icon: 'commentRemove',\n            tooltip: removeCorrectionButtonTitle,\n            onAction: () => removeCorrection(editor)\n        });\n    };\n};\n\n/**\n * Updates the editor content with the correction type and comment.\n * @param {string} data\n * @param {editor} editor\n */\nfunction updateEditorTextContent(data, editor) {\n    const correction_type = data.correction_type;\n    const correction_comment = data.correction_comment;\n\n    let current_selection = editor.selection.getContent({});\n    let updated_selection =\n        `<span class=\"tiny_corrections\">\n                    ${current_selection}\n                    <span class=\"tiny_corrections_correction\">\n                        <sup title=\"${current_selection}\">${correction_type}</sup>\n                        <span class=\"tiny_corrections_comment\">${correction_comment}</span>\n                    </span>\n                </span>`;\n    editor.selection.setContent(updated_selection);\n}\n\n/**\n * Opens the correction modal.\n * @param {editor} editor\n * @returns {void}\n */\nasync function openCorrectionModal(editor) {\n    const [\n        addCorrectionButtonTitle,\n        correctionTypeTitle,\n        commentTitle\n    ] = await Promise.all([\n        getString('button_addcorrection', component),\n        getString('corrtype', component),\n        getString('corrtext', component),\n    ]);\n\n    let correction_types_array = parseCorrectionTypes(editor);\n\n    editor.windowManager.open({\n        title: addCorrectionButtonTitle,\n        body: {\n            type: 'panel',\n            items: [\n                {\n                    type: 'selectbox',\n                    name: 'correction_type',\n                    label: correctionTypeTitle,\n                    items: correction_types_array\n                },\n                {\n                    type: 'textarea',\n                    name: 'correction_comment',\n                    label: commentTitle\n                }\n            ]\n        },\n        buttons: [\n            {\n                type: 'submit',\n                text: 'OK'\n            }\n        ],\n        initialData: {\n            correction_type: 'none',\n            correction_comment: '',\n        },\n        onSubmit: (api) => {\n            const data = api.getData();\n            updateEditorTextContent(data, editor);\n            api.close();\n        }\n    });\n}\n\n/**\n * Fetches the correction types from the server and parses them into an array of objects.\n * @param {editor} editor\n * @returns {{text: *, value: *}[]}\n */\nfunction parseCorrectionTypes(editor) {\n    let correction_types = getCorrTypes(editor);\n    correction_types = correction_types.replace(/\\n$/, '');\n\n    let correction_types_array = correction_types.split('\\n').map((line) => {\n        let [value, text] = line.split('=');\n        return {text: text, value: value};\n    });\n\n    return correction_types_array;\n}\n\n/**\n * Removes the correction on the current selection or cursor position\n * @param {editor} editor\n */\nfunction removeCorrection(editor) {\n    let selection = editor.selection.getNode();\n    if (selection.classList.contains('tiny_corrections')) {\n        selection.querySelector('.tiny_corrections_correction').remove();\n        selection.attributes.removeNamedItem('class');\n    }\n\n}\n"],"names":["async","addCorrectionButtonTitle","removeCorrectionButtonTitle","Promise","all","component","addIcon","fetch","window","M","cfg","wwwroot","then","response","text","removeIcon","editor","ui","registry","contentCSS","push","addButton","icon","tooltip","onAction","correctionTypeTitle","commentTitle","correction_types_array","correction_types","replace","split","map","line","value","parseCorrectionTypes","windowManager","open","title","body","type","items","name","label","buttons","initialData","correction_type","correction_comment","onSubmit","api","data","current_selection","selection","getContent","updated_selection","setContent","updateEditorTextContent","getData","close","openCorrectionModal","getNode","classList","contains","querySelector","remove","attributes","removeNamedItem","removeCorrection"],"mappings":"8NA6BwBA,gBAEhBC,yBACAC,mCACMC,QAAQC,IAAI,EAClB,mBAAU,uBAAwBC,oBAClC,mBAAU,0BAA2BA,yBAGrCC,cAAgBC,MAAMC,OAAOC,EAAEC,IAAIC,QAAU,oDAC5CC,MAAMC,UAAaA,SAASC,SAC7BC,iBAAmBR,MAAMC,OAAOC,EAAEC,IAAIC,QAAU,uDAC/CC,MAAMC,UAAaA,SAASC,gBAEzBE,SACJA,OAAOC,GAAGC,SAASZ,QAAQ,aAAcA,SACzCU,OAAOC,GAAGC,SAASZ,QAAQ,gBAAiBS,YAE5CC,OAAOG,WAAWC,KAAKZ,OAAOC,EAAEC,IAAIC,QAAU,mDAE9CK,OAAOC,GAAGC,SAASG,UAAU,iBAAkB,CAC3CC,KAAM,aACNC,QAAStB,yBACTuB,SAAU,mBAqCaR,cAE3Bf,yBACAwB,oBACAC,oBACMvB,QAAQC,IAAI,EAClB,mBAAU,uBAAwBC,oBAClC,mBAAU,WAAYA,oBACtB,mBAAU,WAAYA,yBAGtBsB,gCA2CsBX,YACtBY,kBAAmB,yBAAaZ,eACpCY,iBAAmBA,iBAAiBC,QAAQ,MAAO,IAEtBD,iBAAiBE,MAAM,MAAMC,KAAKC,WACtDC,MAAOnB,MAAQkB,KAAKF,MAAM,WACxB,CAAChB,KAAMA,KAAMmB,MAAOA,UAjDFC,CAAqBlB,QAElDA,OAAOmB,cAAcC,KAAK,CACtBC,MAAOpC,yBACPqC,KAAM,CACFC,KAAM,QACNC,MAAO,CACH,CACID,KAAM,YACNE,KAAM,kBACNC,MAAOjB,oBACPe,MAAOb,wBAEX,CACIY,KAAM,WACNE,KAAM,qBACNC,MAAOhB,gBAInBiB,QAAS,CACL,CACIJ,KAAM,SACNzB,KAAM,OAGd8B,YAAa,CACTC,gBAAiB,OACjBC,mBAAoB,IAExBC,SAAWC,gBA9DcC,KAAMjC,cAC7B6B,gBAAkBI,KAAKJ,gBACvBC,mBAAqBG,KAAKH,uBAE5BI,kBAAoBlC,OAAOmC,UAAUC,WAAW,IAChDC,iFAEcH,mIAEgBA,+BAAsBL,kGACKC,oFAG7D9B,OAAOmC,UAAUG,WAAWD,mBAmDpBE,CADaP,IAAIQ,UACaxC,QAC9BgC,IAAIS,WAjFYC,CAAoB1C,UAGxCA,OAAOC,GAAGC,SAASG,UAAU,oBAAqB,CAC9CC,KAAM,gBACNC,QAASrB,4BACTsB,SAAU,aAqGIR,YAClBmC,UAAYnC,OAAOmC,UAAUQ,UAC7BR,UAAUS,UAAUC,SAAS,sBAC7BV,UAAUW,cAAc,gCAAgCC,SACxDZ,UAAUa,WAAWC,gBAAgB,UAzGjBC,CAAiBlD"}